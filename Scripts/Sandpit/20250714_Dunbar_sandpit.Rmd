---
title: "20250714_Dunbar_Explore"
author: "Elspeth Sage"
date: "2025-07-14"
output: html_document
---


```{r (1) setup, include=FALSE }
# Setting paths for working directory, retrieving data and saving figures and outputs - CHANGE TO SUIT YOU
scriptpath <- "C:/Users/ElspethSage/OneDrive - THE ROYAL SOCIETY FOR THE PROTECTION OF BIRDS/Documents/BRAIDS/WORKING/Scripts/Sandpit"
datpath <- "C:/Users/ElspethSage/OneDrive - THE ROYAL SOCIETY FOR THE PROTECTION OF BIRDS/Documents/BRAIDS/WORKING/Data"
savepath <- "C:/Users/ElspethSage/OneDrive - THE ROYAL SOCIETY FOR THE PROTECTION OF BIRDS/Documents/BRAIDS/WORKING/Outputs/Sandpit_outputs/20250714_Dunbar_Sandpit"


# Create directories for outputs if not already existing
# ifelse(!dir.exists(paste(savepath, 'Figures', sep = '')), dir.create(paste(savepath, '/Figures', sep = '')), "Folder exists already")
# ifelse(!dir.exists(paste(savepath, 'OutputData', sep = '')), dir.create(paste(savepath, '/OutputData', sep = '')), "Folder exists already")
```

```{r (2) libraries, warning = FALSE, message = FALSE}
library(lubridate)
library(leaflet)
library(leaflet.extras2)
library(dplyr)
library(sp)
library(sf)
library(stringr)
require(htmlwidgets)
library(stringr)
library(data.table)
library(ggplot2)
library(devtools)

# Don't have to run devtools but was planning to have a play with it!
# devtools::install_github('BritishTrustForOrnithology/MoveRakeR', build_vignettes = TRUE)
```


```{R read in GPS accel pressure}
# quick compare of GPS datasets
GPS <- read.csv(paste(datpath, '/Tracks_processed/KITTI/DUN_2025_KITTI_Tracks.csv', sep = ''), header = TRUE, sep = ",", stringsAsFactors=FALSE, row.names = NULL)
GPS2 <- read.csv(paste(datpath, '/Tracks_processed/KITTI/DUN_KITTI_2025_Tracks.csv', sep = ''), header = TRUE, sep = ",", stringsAsFactors=FALSE, row.names = NULL)

GPS <- GPS[order(GPS$Tag_ID, GPS$Year, GPS$Month, GPS$Day, GPS$Hour, GPS$Second),]
GPS2 <- GPS2[order(GPS2$Tag_ID, GPS2$Year, GPS2$Month, GPS2$Day, GPS2$Hour, GPS2$Second),]

GPS$dup <- duplicated(GPS[c(1:7, 15)])
GPS2$dup <- duplicated(GPS2[c(1:7, 15)])


GPS$date_time <- as_datetime(paste(GPS$Year, '/' ,GPS$Month, '/', GPS$Day, '/', GPS$Hour, ':', GPS$Minute, ':', GPS$Second))
GPS2$date_time <- as_datetime(paste(GPS2$Year, '/' ,GPS2$Month, '/', GPS2$Day, '/', GPS2$Hour, ':', GPS2$Minute, ':', GPS2$Second))


GPSsumm <- GPS %>% group_by(Tag_ID) %>% summarise(nfixes = length(date_time), 
                                                  start_time = min(date_time), 
                                                  end_time = max(date_time),
                                                  ndups = sum(dup), 
                                                  minbat = min(Battery), 
                                                  minlat = min(Lat),
                                                  minlon = min(Long),
                                                  maxlon = max(Long))


GPSsumm2 <- GPS2 %>% group_by(Tag_ID) %>% summarise(nfixes = length(date_time), 
                                                  start_time = min(date_time), 
                                                  end_time = max(date_time),
                                                  ndups = sum(dup), 
                                                  minbat = min(Battery), 
                                                  minlat = min(Lat),
                                                  minlon = min(Long),
                                                  maxlon = max(Long))

# Continue with GPS 2 for now until check what Emily also took out - assume more duplicates! 
GPS <- GPS2
rm(GPS2)
```

```{R further basic filtering}
# remove zeros


```


```{R play with moverakeR}
devtools::install_github('BritishTrustForOrnithology/MoveRakeR', build_vignettes = TRUE)

```

```{r just making exploratory maps}
ifelse(!dir.exists(paste(savepath, 'Leaflet_maps', sep = '')), dir.create(paste(savepath, '/Leaflet_maps', sep = '')), "Folder exists already")


# Lef map of all
lefplot <- GPS
# lefplot <- subset(lefplot, Logger == unique(lefplot$Logger)[16])
class_names <- unique(lefplot$tagID)

pal2 <- colorFactor(palette = c("green", "white","blue","pink","red","grey","purple","orange","magenta","yellow", "navy","black","violet"),domain = class_names)

split_data = lapply(unique(lefplot$tagID), function(x) {
  df = as.matrix(lefplot[lefplot$tagID == x, c("longitude", "latitude")])
  lns = Lines(Line(df), ID = x)
  return(lns)
})

data_lines = SpatialLines(split_data)


# lefplota <- sf::st_as_sf(leaflet::atlStorms2005[1, ])
# data$time <- as.POSIXct(
#   seq.POSIXt(Sys.time() - 1000, Sys.time(), length.out = nrow(data))
# )

lef <- leaflet(lefplot) %>%
  addTiles() %>%
  addPolylines(data = data_lines, fillOpacity = 0.6, color = "gray") %>%
  addCircles(data = lefplot, lat = ~ latitude, lng = ~ longitude, color = ~pal2(tagID), fillOpacity = 0.6, popup = paste(" Timestamp = ",lefplot$date_time," individual =", lefplot$tagID))


lef
saveWidget(lef, file=paste(savepath, 'Leaflet_maps/TEST2',".html", sep = ''))

  
  
# Save lef map per individual
for(i in unique(GPSFilt$tagID)){
  lefplot <- subset(GPSFilt, tagID == i)
  
  # lefplot <- subset(lefplot, Logger == unique(lefplot$Logger)[16])
  class_names <- unique(lefplot$tagID)
  
  pal2 <- colorFactor(palette = c("green", "white","blue","pink","red","grey","purple","orange","magenta","yellow"),domain = class_names)
  
  # split_data = lapply(unique(lefplot$tagID), function(x) {
  #   df = as.matrix(lefplot[lefplot$tagID == x, c("longitude", "latitude")])
  #   lns = Lines(Line(df), ID = x)
  #   return(lns)
  # })
  # 
  # split_data$time <- lefplot$date_time
  # data_lines = SpatialLines(split_data)
  
  
  data <- sf::st_as_sf(lefplot, coords = c("latitude", "longitude"), crs = 28992)
  data <- st_cast(data, "POINT")
  data$time <- as.POSIXct(
  seq.POSIXt(Sys.time() - 1000, Sys.time(), length.out = nrow(data))
  )

  
  lef <- leaflet(lefplot) %>%
    addTiles() %>%
    addPolylines(data = data, fillOpacity = 0.6, color = "gray") %>%
    addCircles(data = lefplot, lat = ~ latitude, lng = ~ longitude, color = ~pal2(tagID), fillOpacity = 0.6, popup = paste(" Timestamp = ",lefplot$date_time," individual =", lefplot$tagID, " GPS alt =", lefplot$altitude_GPS)) %>%
      addTimeslider(data = data,options = timesliderOptions(position = "topright",timeAttribute = "time",range = TRUE))
  
  lef
  saveWidget(lef, file=paste(savepath, 'Leaflet_maps/lefmap_',lefplot$filename[1],".html", sep = ''))
}

# Save lef map per individual with time slider
count <- 1
for(i in unique(GPS$Tag_ID)){
  lefplot <- subset(GPS, Tag_ID == i)
  
  pal <-  c("green", "darkgreen","blue","navy","red","deeppink4","purple","orange","magenta","yellow")
  
data_points <- sp::SpatialPoints(cbind(lefplot$Long,lefplot$Lat),CRS("+proj=longlat +datum=WGS84"))

data_lines <- sp_line <- as(data_points,"SpatialLines")

data_geom <- st_as_sf(data_points, coords = c("x", "y"), crs = 28992, agr = "constant")
data <- st_cast(data_geom, "POINT")
data$time <- as.POSIXct(lefplot$date_time)

lef <- leaflet() %>%
  addTiles() %>%
  addPolylines(data = data_lines, fillOpacity = 0.4, color = "gray", weight = 2) %>%
  addCircles(lng = lefplot$Long, lat = lefplot$Lat, color = pal[count], fillColor = pal[count], popup = paste(" Timestamp = ",lefplot$date_time," individual =", lefplot$TagID, " GPS alt =", lefplot$Altitude_GPS),radius = 1.5, fillOpacity = 0.2, weight = 1, stroke = "FALSE") %>%
  addTimeslider(data = data, fillOpacity = 0.2, radius  = 5, weight = 1, color = pal[count], fillColor = pal[count],
                popup = paste(" Timestamp = ",lefplot$date_time," individual =", lefplot$TagID, " GPS alt =", lefplot$Altitude_GPS),
                options = timesliderOptions(position = "topright",timeAttribute = "time",range = TRUE))
  
  lef
  saveWidget(lef, file=paste(savepath, '/Leaflet_maps/2TimeSlider_lefmap_',lefplot$Tag_ID[1],".html", sep = ''))
  
  count <- count +1
}
``` 

```{R fun plotting pressures}
# Loop through loggers and their unique days to generate a pressure time series per logger per day
pressFilt$day <- day(pressFilt$date_time)

Ns <- unique(pressFilt$tagID)

for(i in Ns){
  dataN <- subset(pressFilt, tagID == i)

    p <- ggplot(dataN)+
    geom_point(aes(x = date_time, y = pressure), alpha = 0.5, stroke = NA)+
      theme_bw(base_size = 10)+
      labs(title = (paste('Flight trial, ', date(dataN$date_time[1]), ' tagID: ', i, sep = '')))+
      xlab('date_time')
      ylab('pressure')
    
    title <- paste(savepath,'Figures/Pressurefigures/Dunbar_', date(dataN$date_time[1]),'_', date(dataN$date_time[nrow(dataN)]),'_logger_', i, '.png', sep = '') 
    ggsave(title,plot = p,width = 15, height = 6, dpi = 150, units = "in", device='png')
  }

# plot strange tag day bday
press35853_1 <- filter(pressFilt, tagID == 35853 & pressure < 3000)
press35853_2 <- filter(pressFilt, tagID == 35853 & pressure >= 3000)

p1 <- ggplot(press35853_1)+
  geom_point(aes(x = date_time, y = pressure), alpha = 0.5, stroke = NA)+
  theme_bw(base_size = 10)+
  labs(title = (paste('Flight trial, ', date(press35853_1$date_time[1]), ' tagID: 35853', sep = '')))+
  xlab('date_time')
ylab('pressure')

title <- paste(savepath,'Figures/Pressurefigures/Dunbar_', date(press35853_1$date_time[1]),'_', date(press35853_1$date_time[nrow(press35853_1)]),'_logger_35853i.png', sep = '') 
ggsave(title,plot = p1, width = 15, height = 6, dpi = 150, units = "in", device='png')

p2 <- ggplot(press35853_2)+
  geom_point(aes(x = date_time, y = pressure), alpha = 0.5, stroke = NA)+
  theme_bw(base_size = 10)+
  labs(title = (paste('Flight trial, ', date(press35853_2$date_time[1]), ' tagID: 35853', sep = '')))+
  xlab('date_time')
ylab('pressure')

title <- paste(savepath,'Figures/Pressurefigures/Dunbar_', date(press35853_2$date_time[1]),'_', date(press35853_2$date_time[nrow(press35853_2)]),'_logger_35853ii.png', sep = '') 
ggsave(title,plot = p2, width = 15, height = 6, dpi = 150, units = "in", device='png')

``` 

```{R fun plotting Accelerometer}
# Loop through loggers and their unique days to generate a pressure time series per logger per day
Accel$day <- day(Accel$date_time)

Ns <- unique(Accel$tagID)

for(i in Ns){
  dataN <- subset(Accel, tagID == i)

    p <- ggplot(dataN)+
    geom_point(aes(x = date_time, y = zacc, color = "z accel"), alpha = 0.5, stroke = NA, fill = 'black')+
      geom_point(aes(x = date_time, y = yacc, color = "y accel"), alpha = 0.5, stroke = NA, fill = 'red')+
      geom_point(aes(x = date_time, y = xacc, color = "x accel"), alpha = 0.5, stroke = NA, fill = 'blue')+
      theme_bw(base_size = 10)+
      labs(title = (paste('Flight trial, ', date(dataN$date_time[1]), ' tagID: ', i, sep = '')))+
      xlab('date_time')
      ylab('Acceleration [g]')
    
    title <- paste(savepath,'Figures/Accelerometerfigures/Dunbar_', date(dataN$date_time[1]),'_', date(dataN$date_time[nrow(dataN)]),'_logger_', i, '.png', sep = '') 
    ggsave(title,plot = p,width = 15, height = 6, dpi = 150, units = "in", device='png')
}
```

```{R more exploratory plots}
# plot time intervals
plotdat <- GPSFilt

ggplot(GPSFilt)+
  geom_histogram(data = GPSFilt, aes(x = timeinterval_f))+
  facet_wrap(~tagID, scales = "free")


ggplot(GPS)+
  geom_point(data = GPS, aes(x = date_time, y = latitude))+
  facet_wrap(~tagID, scales = "free")

ggplot(GPSFilt)+
  geom_point(data = GPSFilt, aes(x = date_time, y = latitude))+
  facet_wrap(~tagID, scales = "free")
  

``` 


```{R dygraphs!}

library(dygraphs)
library(xts)

tempGPS <- subset(GPSFilt, tagID == 35903)
tempp <- subset(pressFilt, tagID == 35903) %>% dplyr::select(pressure, date_time)
temp <- subset(Accel, tagID == 35903) %>% dplyr::select(zacc, xacc, yacc, date_time)
xtsdatAcc <- xts(temp, order.by = temp$date_time, tz="UTC")
xtsdatPr <- xts(tempp, order.by = tempp$date_time, tz="UTC")


startrange <- as_date(min(dydat$date_time))
endrange <- max(dydat$date_time)

dygraph(Accel$zacc, main = "test") %>% 
  dyRangeSelector(dateWindow = c(min(Accel), "1960-01-01"))


dyAcc <-dygraph(xtsdatAcc, main = "Acceleration",group = "tagID 35903") %>% 
  dyAxis("y", label = "Acceleration (g)", valueRange = c(-4.2, 4.2)) %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyRangeSelector() %>%
  dyOptions(axisLineWidth = 0.1, strokePattern = "dashed")

dygraph(xtsdatPr, main = "Pressure", group = "tagID 35903") %>% 
  dyAxis("y", label = "Pressure (mBar)",) %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 2)) %>%
  dyRangeSelector() %>%
  dyOptions(axisLineWidth = 1)



saveWidget(dyAcc, file=paste(savepath, '/Figures/Acc_dygraph_',tempGPS$tagID[1],".html", sep = ''))

Ns <- unique(Accel$tagID)
# Accelerometer figures per individual
for(i in Ns){
  dataN <- subset(Accel, tagID == i)

  temp <- subset(dataN, tagID == i) %>% dplyr::select(zacc, xacc, yacc, date_time)
  xtsdatAcc <- xts(temp, order.by = temp$date_time, tz="UTC")
  
  dyAcc <-dygraph(xtsdatAcc, main = paste("tag ID", dataN$tagID[1], sep = " "), group = paste("tag ID", dataN$tagID[1], sep = " ")) %>% 
  dyAxis("y", label = "Acceleration (g)", valueRange = c(-4.2, 4.2)) %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyRangeSelector() %>%
  dyOptions(axisLineWidth = 0.1, strokePattern = "dashed")
    
    title <- paste(savepath,'Figures/Accelerometerfigures/Dy_Dunbar_Accel', date(dataN$date_time[1]),'_', date(dataN$date_time[nrow(dataN)]),'_logger_', i, '.png', sep = '') 
    
    saveWidget(dyAcc, file=paste(savepath,'Figures/Accelerometerfigures/Dy_Dunbar_Accel_', date(dataN$date_time[1]),'_', date(dataN$date_time[nrow(dataN)]),'_logger_', i, '.html', sep = ''))
}

```


```{R trying to get leaflet working properly}
# start with tempGPS - one individual
data_points <- sp::SpatialPoints(cbind(tempGPS$longitude,tempGPS$latitude),CRS("+proj=longlat +datum=WGS84"))

data_lines <- sp_line <- as(data_points,"SpatialLines")

data_geom <- st_as_sf(data_points, coords = c("x", "y"), crs = 28992, agr = "constant")
data <- st_cast(data_geom, "POINT")
data$time <- as.POSIXct(tempGPS$date_time)

lef <- leaflet() %>%
  addTiles() %>%
  addPolylines(data = data_lines, fillOpacity = 0.4, color = "gray", weight = 2) %>%
  addCircles(lng = tempGPS$longitude, lat = tempGPS$latitude, popup = paste(" Timestamp = ",lefplot$date_time," individual =", lefplot$tagID, " GPS alt =", lefplot$altitude_GPS),radius = 0.2, fillOpacity = 0.1, weight = 1, stroke = "FALSE") %>%
  addTimeslider(data = data,fillOpacity = 0.2, radius  = 5, weight = 1, options = timesliderOptions(position = "topright",timeAttribute = "time",range = TRUE,),fillOpacity = 0.2, radius  = 5, weight = 1)

``` 

